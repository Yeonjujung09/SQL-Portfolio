--Q11
WITH calls AS (
SELECT
FORMAT(call_date, 'yyyy-MM-dd HH') AS Hr
,CAST(FORMAT(call_date, 'HH') AS INT) AS hour
,call_ref
FROM issue
WHERE FORMAT(call_date, 'yyyy-MM-dd')= '2017-08-12'
)
,managers AS (
SELECT
manager
,CAST(LEFT(start_time, 2) AS INT) AS start_time
,CAST(LEFT(end_time, 2) AS INT)-1 AS end_time
FROM shift
JOIN shift_type ON shift.shift_type = shift_type.shift_type
WHERE FORMAT(shift_date, 'yyyy-MM-dd')='2017-08-12'
)
SELECT
Hr
,manager
,COUNT(*) AS cc
FROM calls
JOIN managers ON calls.hour BETWEEN managers.start_time AND managers.end_time
GROUP BY Hr, manager
ORDER BY Hr

--Q12
WITH top20 AS (
SELECT
caller_id
FROM (
SELECT
caller_id
,COUNT(*) AS calls
,PERCENT_RANK() OVER (ORDER BY COUNT(*) DESC) AS rank
FROM issue
GROUP BY caller_id
) AS sub
WHERE rank<=0.2
)
SELECT
COUNT(top20.caller_id)*100.0/COUNT(call_ref)
FROM issue
LEFT JOIN top20 ON issue.caller_id = top20.caller_id

--Q13
WITH shift_time AS (
SELECT
CONVERT(NVARCHAR, start_time, 8) AS start_time
,CONVERT(NVARCHAR, end_time, 8) AS end_time
FROM shift_type
)
,call_time AS (
SELECT
call_ref
,caller_id
,FORMAT(call_date, 'HH:mm') AS call_time
FROM issue
)
,annoyers AS (
SELECT
caller_id
FROM call_time
LEFT JOIN shift_time ON call_time.call_time BETWEEN shift_time.start_time AND shift_time.end_time
WHERE call_time BETWEEN DATEADD(mi, -5, end_time) AND end_time
)
SELECT
company_name
,COUNT(*) AS abna
,RANK() OVER (ORDER BY COUNT(*) DESC) AS rank
FROM issue
JOIN caller ON issue.caller_id = caller.caller_id
JOIN customer ON caller.company_ref = customer.company_ref
WHERE NOT EXISTS (
SELECT 1
FROM annoyers
WHERE annoyers.caller_id = issue.caller_id
)
GROUP BY company_name

--Q14
WITH calls AS (
SELECT FORMAT(call_date, 'yyyy-MM-dd') AS call_date
,call_ref
,caller_id
FROM issue
WHERE FORMAT(call_date, 'yyyy-MM-dd')='2017-08-13'
)
,company_list AS (
SELECT
company_name
,COUNT(caller.caller_id) AS caller_count
,COUNT(calls.caller_id) AS registered_callers
FROM customer
JOIN caller ON customer.company_ref = caller.company_ref
LEFT JOIN calls ON caller.caller_id = calls.caller_id
GROUP BY company_name
)
SELECT *
FROM company_list
WHERE caller_count = registered_callers

--Q11
WITH bookings AS (
SELECT 
booking_id
,FORMAT(booking_date, 'yyyy-MM-dd') AS first_night
,FORMAT(DATEADD(day, nights-1, booking_date), 'yyyy-MM-dd') AS last_night
,first_name
,last_name
FROM booking
JOIN guest ON booking.guest_id = guest.id
)
SELECT DISTINCT
b1.last_name
,b1.first_name
,b2.first_name
FROM bookings AS b1
JOIN bookings AS b2 
ON b1.last_name = b2.last_name
AND b1.first_name > b2.first_name
AND b1.first_night <= b2.first_night
AND b1.last_night >= b2.first_night
ORDER BY last_name

--Q14
WITH base AS (
SELECT 
booking.booking_id
,FORMAT(DATEADD(day, nights, booking_date), 'yyyy-MM-dd') AS checkout_date
,FORMAT(DATEADD(day, nights, booking_date), 'dddd') AS dow
,rate.amount * nights AS sales_amount
FROM booking
JOIN rate ON booking.room_type_requested = rate.room_type 
AND booking.occupants = rate.occupancy
)
,weekly_sales AS (
SELECT
DATEADD(day, 11, DATETRUNC(week, DATEADD(day, -5, checkout_date))) AS week_start
,SUM(sales_amount) AS weekly_income
FROM base
GROUP BY DATEADD(day, 11, DATETRUNC(week, DATEADD(day, -5, checkout_date)))
)
SELECT *
FROM weekly_sales
